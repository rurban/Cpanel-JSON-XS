{"version":1,"ops":[{"type":1,"author":{"id":"14b6bcfbb67424c733eb6e78d6df4126e0d229ba"},"timestamp":1621543400,"metadata":{"github-id":"MDU6SXNzdWU4OTc0MzI5MTM=","github-url":"https://github.com/rurban/Cpanel-JSON-XS/issues/179","origin":"github"},"title":"Segmentation fault in XS.so","message":"Hello.\n\nI'm facing an intermittent issue in a web site of mine, which runs in Ubuntu 20.04, mainly with Apache 2.4.41, Perl 5.30.0 and mod_perl 2.0.11.\n\nAfter a lot of debugging I found a minimal way to reproduce it, according to the following details.\n\n### Setup the server environment\nThis assumes a fresh Ubuntu 20.04 installation for an x86_64 CPU.\n\n- Run these commands:\n    `apt-get install apache2`\n    `apt-get install libapache2-mod-perl2`\n    `apt-get install libcrypt-jwt-perl # this one installs these dependencies: libcpanel-json-xs-perl{a} libcryptx-perl{a} and libjson-maybexs-perl{a}`\n    `mkdir /var/perl_code`\n\n- Create the file /etc/apache2/sites-available/buggy-site.com.conf with this content:\n\n      \u003cVirtualHost *:80\u003e\n        ServerName buggy-site.com\n\n        DocumentRoot /var/perl_code\n\n        ErrorLog ${APACHE_LOG_DIR}/buggy-site-error.log\n        CustomLog ${APACHE_LOG_DIR}/buggy-site-access.log combined\n\n        \u003cDirectory \"/var/perl_code\"\u003e\n                Options ExecCGI\n                DirectoryIndex index.pl\n                \u003cIfVersion \u003e= 2.3\u003e\n                        Require all granted\n                \u003c/IfVersion\u003e\n                AllowOverride All\n                \u003cFiles *.pl\u003e\n                        SetHandler perl-script\n                        Options +ExecCGI\n                        PerlResponseHandler ModPerl::Registry\n                        PerlSendHeader On\n                \u003c/Files\u003e\n        \u003c/Directory\u003e\n      \u003c/VirtualHost\u003e\n\n- Create the file /var/perl_code/index.pl with this content:\n\n      #!/usr/bin/perl -w\n      use strict;\n      use warnings;\n      # this single line is enough to trigger the segmentation fault\n      use Crypt::JWT;\n      print 'Content-Type: ' . 'application/json' . \"\\r\\n\";\n      print 'Content-Disposition: attachment;filename=\"' . 'attached_file.json' . \"\\\"\\r\\n\";\n      print \"Accept-Ranges: bytes\\r\\n\";\n      my $response_content = '{\"responses\":[{\"code\":\"200\",\"message\":\"OK\",\"key\":\"\"}],\"data\":{\"found\":1}}';\n      print 'Content-Length: ' . length( $response_content ) . \"\\r\\n\";\n      print \"\\r\\n\";\n      print $response_content;\n\n- Enable the virtual host site with these commands:\n    `a2ensite buggy-site.com.conf`\n    `systemctl restart apache2.service`\n\n### Setup the client environment\nI assume the client has a terminal to run commands, with the `wget` installed to open URLs.\n\nTo emulate a public we site, edit its /etc/hosts file to add a line that associates the IP address of the server with the sample domain name of the configured web site. In my example, that line would be like this:\n\n      192.168.1.100 buggy-site.com\n\nAn alternative to this is to have a DNS record that correctly associates the server IP address with the domain name of the sample web site.\n\n### Use the web site\nFrom this moment on, I will mention two sides in turns, one for the server and other for the client.\n\n- In the client, I'm using this command to access the configured web site whenever I want:\n\n    `wget --server-response --output-document=- http://buggy-site.com`\n\nNo matter how many times I execute that `wget`command, no errors will happen (or at least I did not observe hints about it). I presume that this is because the Apache web server is running multiple processes, given the MPM \"prefork\", \"event\" or \"worker\" modules that are generally used. Also, in my web site having such multiple processes increased the difficulty to debug and isolate the error.\n\n- In the server, open a terminal to monitor the Apache and operating system log files, for example with this command:\n\n    `tail -f /var/log/apache2/*.log /var/log/syslog`\n\n- In the server, stop the Apache web server with this command:\n\n    `systemctl stop apache2.service`\n\n- In the server, start the Apache web server in debug mode with these commands:\n\n    `source /etc/apache2/envvars`\n    `apache2 -X`\n\nThat is convenient to run the Apache web server with a single process.\n\n- In the client, run the `wget` command previously given to access the web site. That command finishes successfully, getting the expected content from the server. At this moment the server works normally, without showing symptoms of an error.\n\n### Trigger the error\nIn the server, go to the terminal that keeps running the `apache2 -X` command and stop it by pressing the \"Ctrl + C\" keys sequence.\nAfter doing that, these things will happen:\n\n- The terminal where the `apache2 -X` was running will show this mesage:\n\n      Segmentation fault (core dumped)\n\n- The /var/log/syslog file will show a couple of lines like these:\n\n      May 20 15:18:44 localhost kernel: [ 1435.562727] apache2[6398]: segfault at 8 ip 00007f57c06b7f47 sp 00007ffd0bacf8e8 error 4 in XS.so[7f57c06b7000+f000]\n      May 20 15:18:44 localhost kernel: [ 1435.562743] Code: 1f 40 00 f3 0f 1e fa 48 63 15 dd 30 01 00 48 8b 87 78 0b 00 00 48 83 6f 78 04 48 8b 04 d0 48 8b 70 30 48 c7 40 30 00 00 00 00 \u003c8b\u003e 56 08 83 fa 01 76 11 83 ea 01 89 56 08 c3 66 2e 0f 1f 84 00 00\n\nI presume that the mentioned XS.so file in the first line corresponds to the /usr/lib/x86_64-linux-gnu/perl5/5.30/auto/Cpanel/JSON/XS/XS.so file, which is probably opened as part of the following sequence of opened files:\n\n      /usr/local/share/perl/5.30.0/Crypt/JWT.pm\n      /usr/local/lib/x86_64-linux-gnu/perl/5.30.0/Crypt/Misc.pm\n      /usr/local/lib/x86_64-linux-gnu/perl/5.30.0/CryptX.pm\n      /usr/lib/x86_64-linux-gnu/perl5/5.30/Cpanel/JSON/XS.pm\n      /usr/lib/x86_64-linux-gnu/perl5/5.30/auto/Cpanel/JSON/XS/XS.so\n\n- A core dump file will appear under the /var/crash/ directory.\n\n### My observations\n- The system has these packages installed:\n\n      libcrypt-jwt-perl (version 0.026-1)\n      libcryptx-perl (version 0.067-1)\n      libcpanel-json-xs-perl (version 4.19-1build1)\n      libjson-maybexs-perl (version 1.004000-1)\n\n- The Perl module Crypt::JWT depends on CryptX, which uses a JSON::XS implementation or JSON::PP, preferring Cpanel::JSON::XS when selecting one of them. This is evident from this code fragment taken from the /usr/local/lib/x86_64-linux-gnu/perl/5.30.0/CryptX.pm file in the server:\n\n      ...\n      our $VERSION = '0.069';\n      ...\n      BEGIN {\n        if (eval { require Cpanel::JSON::XS }) {\n          Cpanel::JSON::XS-\u003eimport(qw(encode_json decode_json));\n          $has_json = 1;\n        }\n        elsif (eval { require JSON::XS }) {\n          JSON::XS-\u003eimport(qw(encode_json decode_json));\n          $has_json = 2;\n        }\n        elsif (eval { require JSON::PP }) {\n          JSON::PP-\u003eimport(qw(encode_json decode_json));\n          $has_json = 3;\n        }\n        else {\n          $has_json = 0;\n        }\n      }\n\n- Given that first preference that CryptX has, I think that the segmentation fault is caused by some bug in the Cpanel::JSON::XS implementation, however I could be wrong, in which case I will need to create an issue for that CryptX module.\n\n### A workaround\nInstalling JSON::XS and removing Cpanel::JSON::XS brings these two things:\n\n- Stops the segmentation fault from happening when executing the `apache2 -X` command.\n- Stops the intermittent issue I faced with the web site of mine.\n\nTo do that, these are the commands to execute in the server:\n\n    aptitude install libjson-xs-perl\n    aptitude remove libcpanel-json-xs-perl\n\n### What to do?\n- If possible I would like to have this issue confirmed, solved and with a fix published for Ubuntu 20.04.\n- Also, I would like to keep using the Cpanel::JSON::XS module because its documentation says that it \"...has proper ithreads support...\" and because it is frequently updated and enhanced.\n\nIn case there is something that I could help with, it would be my pleasure.\nThanks in advance for your time and attention.","files":null}]}