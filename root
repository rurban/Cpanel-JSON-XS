{"version":1,"ops":[{"type":1,"author":{"id":"18b679769de381b852b3ed5d3832bd5ebc63157a"},"timestamp":1490760425,"metadata":{"github-id":"MDU6SXNzdWUyMTc3NTk0NTA=","github-url":"https://github.com/rurban/Cpanel-JSON-XS/issues/84","origin":"github"},"title":"Performance/memory bug with need()","message":"Howdy,\n\nI just sent this to schmorp about JSON::XS, thought you might be interested in fixing this in Cpanel::JSON::XS.\n\nThanks,\n\n-- Matthew Horsfall (alh)\n\n---------- Forwarded message ----------\n\nHowdy,\n\nI discovered an issue recently with JSON::XS performance on solaris\nwith high-ascii bytes in the payload when encoding.\n\nIt turned out to be a combination of two issues:\n\n  - perl was compiled with -lumem and ithreads\n  - JSON::XS was calling realloc a *LOT*\n\nThis was easy to demonstrate with...\n\n````\n  perl -MJSON::XS -e 'my $x = join q{}, map { chr rand 256 } (0 ..\n1e6); $j = encode_json([ $x ]);'\n````\n\nThis would take *minutes* (if linked against libumem!).\n\nIf I instead used JSON::PP, this took seconds.\n\nThe problem is that if you did this:\n\n````\n  perl -MJSON::XS -e 'my $x = join q{}, map { chr rand 256 } (0..20);\n$j = encode_json([ $x ]);'\n````\n\n...JSON::XS calls realloc *20* times - the same amount as the input string.\n\nThis is because JSON::XS defines a function need() that expects a \"I\nneed this many more bytes than I have\" argument, but often JSON::XS is\npassing it \"current length + length that I need\".\n\nThis has two impacts - performance, since we're guaranteed to realloc\nonce per non-printable character - and memory utilization, since for\n2000 bytes we end up consuming roughly 240k of memory.\n\nWith my attached patch, both of these issues go away. Memory usage\nbecomes more sane and the problem with libumem is non-existent.\n\nThe patch isn't perfect since there's one or two places where I'm not\nsure just how many bytes we actually need, but I imagine you can\nfigure it out (I marked them with comments).\n\nThanks,\n\n-- Matthew Horsfall (alh)\n[patch.txt](https://github.com/rurban/Cpanel-JSON-XS/files/877781/patch.txt)","files":null}]}