{"version":1,"ops":[{"type":6,"author":{"id":"9bc4032fe2eafeed0467f2535d4d701527283659"},"timestamp":1554348199,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdDIwNTMxNTg2OQ=="},"target":"879f9b98771cfdb3d54c69227defdc72f55b36491a5cd85706086a8bd72193fd","message":"While overloading array we get segfault on perl-5.26.1, Cpanel::JSON::XS-4.11\n\nSame code works properly on perl-5.16, Cpanel::JSON::XS-3.0115 and perl-5.18, Cpanel::JSON::XS-3.0213\n\nHere's the code,\n```#!/usr/bin/perl\n\nuse JSON -convert_blessed_universally;\nuse Cpanel::JSON::XS ();\n\nour $Json = Cpanel::JSON::XS-\u003enew-\u003eallow_nonref-\u003eallow_blessed-\u003econvert_blessed-\u003ecanonical;\n\nmy $ar = [\n  {\n    'closeTime' =\u003e '18:00',\n    'openTime' =\u003e '09:00',\n    'closeDay' =\u003e 'MONDAY',\n    'openDay' =\u003e 'MONDAY'\n  },\n];\n\nmy $var = bless( $ar, 'TestArray' ); \n\nprint \"\\$var : \",$Json-\u003eencode($var),\"\\n\";\n\npackage TestArray;\n\nuse overload\n    '\"\"'  =\u003e sub { $Json-\u003eencode($_[0]) },\n    bool  =\u003e sub { !! @{$_[0]} },\n    '0+'  =\u003e sub { scalar(@{$_[0]}) },\n    '+'   =\u003e sub { scalar(@{$_[0]}) + $_[1] },\n    '-'   =\u003e sub { $_[2] ? $_[1] - scalar(@{$_[0]}) : scalar(@{$_[0]}) - $_[1] },\n    '*'   =\u003e sub { scalar(@{$_[0]}) * $_[1] },\n    '\u003c=\u003e' =\u003e sub { $_[2] ? $_[1] \u003c=\u003e scalar(@{$_[0]})  : scalar(@{$_[0]})  \u003c=\u003e $_[1] },\n    'cmp' =\u003e sub { $_[2] ? $_[1] cmp scalar(@{$_[0]})  : scalar(@{$_[0]})  cmp $_[1] },\n    '~~'  =\u003e sub { $_[2] ? $_[1] ~~ [ @{$_[0]} ] : [ @{$_[0]} ] ~~ $_[1] },\n    ;\n```\nOutput on servers running perl5.16 and perl5.18,\n$var : [{\"closeDay\":\"MONDAY\",\"closeTime\":\"18:00\",\"openDay\":\"MONDAY\",\"openTime\":\"09:00\"}]\n\nTrace from GDB,\n```(gdb) bt full\n#0  0x00005555555b3564 in Perl_gv_fetchmethod_pvn_flags ()\nNo symbol table info available.\n#1  0x00007ffff6845b0d in encode_sv () from /usr/lib/perl5/vendor_perl/5.26.1/x86_64-linux-thread-multi/auto/Cpanel/JSON/XS/XS.so\nNo symbol table info available.\n#2  0x00007ffff68477b5 in encode_json () from /usr/lib/perl5/vendor_perl/5.26.1/x86_64-linux-thread-multi/auto/Cpanel/JSON/XS/XS.so\nNo symbol table info available.\n#3  0x00007ffff6847b54 in XS_Cpanel__JSON__XS_encode ()\n   from /usr/lib/perl5/vendor_perl/5.26.1/x86_64-linux-thread-multi/auto/Cpanel/JSON/XS/XS.so\nNo symbol table info available.\n#4  0x00005555556334f1 in Perl_pp_entersub ()\nNo symbol table info available.\n#5  0x000055555562b316 in Perl_runops_standard ()\nNo symbol table info available.\n#6  0x00005555555b4a8e in Perl_amagic_call ()\nNo symbol table info available.\n#7  0x00007ffff68409ab in encode_stringify () from /usr/lib/perl5/vendor_perl/5.26.1/x86_64-linux-thread-multi/auto/Cpanel/JSON/XS/XS.so\nNo symbol table info available.\n#8  0x00007ffff6845db9 in encode_sv () from /usr/lib/perl5/vendor_perl/5.26.1/x86_64-linux-thread-multi/auto/Cpanel/JSON/XS/XS.so\nNo symbol table info available.\n#9  0x00007ffff68477b5 in encode_json () from /usr/lib/perl5/vendor_perl/5.26.1/x86_64-linux-thread-multi/auto/Cpanel/JSON/XS/XS.so\nNo symbol table info available.\n#10 0x00007ffff6847b54 in XS_Cpanel__JSON__XS_encode ()\n   from /usr/lib/perl5/vendor_perl/5.26.1/x86_64-linux-thread-multi/auto/Cpanel/JSON/XS/XS.so\nNo symbol table info available.\n#11 0x00005555556334f1 in Perl_pp_entersub ()\nNo symbol table info available.\n#12 0x000055555562b316 in Perl_runops_standard ()\nNo symbol table info available.\n#13 0x00005555555b4a8e in Perl_amagic_call ()\nNo symbol table info available.\n#14 0x00007ffff68409ab in encode_stringify () from /usr/lib/perl5/vendor_perl/5.26.1/x86_64-linux-thread-multi/auto/Cpanel/JSON/XS/XS.so```","files":null},{"type":5,"author":{"id":"42b8049125821cad60d350df07d9d216b854f3f7"},"timestamp":1554349075,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDIyNTE2NzczMzI="},"added":["bug"],"removed":[]},{"type":5,"author":{"id":"42b8049125821cad60d350df07d9d216b854f3f7"},"timestamp":1554349091,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDIyNTE2Nzc3MjE="},"added":["regression"],"removed":[]},{"type":3,"author":{"id":"42b8049125821cad60d350df07d9d216b854f3f7"},"timestamp":1554412848,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDQ4MDA2Njg2MA==","github-url":"https://github.com/rurban/Cpanel-JSON-XS/issues/128#issuecomment-480066860"},"message":"The problem is an endless recursion in the string overload calling encode again (and again). Working on it.","files":null},{"type":6,"author":{"id":"42b8049125821cad60d350df07d9d216b854f3f7"},"timestamp":1554412848,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdDIwNTc2ODM0Ng=="},"target":"36dbc6b2d868fe06b462e3b747e6cff25861fcea1335a3d9c641939ee6b2417e","message":"The problem is an endless recursion in the string overload calling encode again (and again). Working on it. It started with v5.24","files":null},{"type":6,"author":{"id":"42b8049125821cad60d350df07d9d216b854f3f7"},"timestamp":1554412879,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdDIwNTc2ODU0Mw=="},"target":"36dbc6b2d868fe06b462e3b747e6cff25861fcea1335a3d9c641939ee6b2417e","message":"The problem is an endless recursion in the string overload calling encode again (and again). Working on it. It started with v5.24, v5.22 is fine.","files":null},{"type":6,"author":{"id":"42b8049125821cad60d350df07d9d216b854f3f7"},"timestamp":1554413023,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdDIwNTc2OTQyMw=="},"target":"36dbc6b2d868fe06b462e3b747e6cff25861fcea1335a3d9c641939ee6b2417e","message":"The problem is an endless recursion in the string overload calling encode again (and again). Working on it. It started with v5.24, v5.22 is fine. v5.22c is also affected.","files":null},{"type":3,"author":{"id":"9bc4032fe2eafeed0467f2535d4d701527283659"},"timestamp":1555040053,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDQ4MjQyNDQzNQ==","github-url":"https://github.com/rurban/Cpanel-JSON-XS/issues/128#issuecomment-482424435"},"message":"Tried the patch but it still goes with endless loop.","files":null},{"type":3,"author":{"id":"42b8049125821cad60d350df07d9d216b854f3f7"},"timestamp":1555041799,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDQ4MjQyOTEwMA==","github-url":"https://github.com/rurban/Cpanel-JSON-XS/issues/128#issuecomment-482429100"},"message":"Yes, it's not working yet","files":null},{"type":6,"author":{"id":"42b8049125821cad60d350df07d9d216b854f3f7"},"timestamp":1555041799,"metadata":{"github-id":"MDE1OlVzZXJDb250ZW50RWRpdDIwODk0OTI0OA=="},"target":"c0d5181f3d9fc61aadb957215a16f071c9b19ab1eb0e6a55602b16a478772502","message":"Yes, it's not working yet. That's why it's called WIP (work in progress)","files":null},{"type":3,"author":{"id":"9bc4032fe2eafeed0467f2535d4d701527283659"},"timestamp":1557549087,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDQ5MTQ3ODYxOQ==","github-url":"https://github.com/rurban/Cpanel-JSON-XS/issues/128#issuecomment-491478619"},"message":"Hi Reini,\n\nOur server upgrades are blocked due to this. Can this be fixed?","files":null},{"type":3,"author":{"id":"42b8049125821cad60d350df07d9d216b854f3f7"},"timestamp":1557549730,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDQ5MTQ3OTA1Mw==","github-url":"https://github.com/rurban/Cpanel-JSON-XS/issues/128#issuecomment-491479053"},"message":"Not easy, still trying. Case is, it's forbidden by the docs already. So I would advise not to use encode in a hook/overload. \n\nBut since it's a regression, I'm trying to lift this limitation of recursive hook calls. 2 attempts failed so far. See my branches.","files":null},{"type":3,"author":{"id":"9bc4032fe2eafeed0467f2535d4d701527283659"},"timestamp":1557684384,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDQ5MTYxNjQ1Mg==","github-url":"https://github.com/rurban/Cpanel-JSON-XS/issues/128#issuecomment-491616452"},"message":"Thanks Reini.\n\nI tried without encode function in overload and I get 'null'. Here also the same code works in old perl.\n\nI just changed this line,\n'\"\"'  =\u003e sub { $Json-\u003eencode($_[0]) }\nto\n'\"\"'  =\u003e sub { $_[0] }","files":null},{"type":3,"author":{"id":"42b8049125821cad60d350df07d9d216b854f3f7"},"timestamp":1560173337,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDUwMDQxNjgyMA==","github-url":"https://github.com/rurban/Cpanel-JSON-XS/issues/128#issuecomment-500416820"},"message":"Even if it's a regression I added now to the documentation that such recursive hooks are forbidden. (as already with TO_JSON)\nI'm still trying to fix it though, but so far no luck. It breaks too much other stuff.","files":null},{"type":5,"author":{"id":"42b8049125821cad60d350df07d9d216b854f3f7"},"timestamp":1560173797,"metadata":{"github-id":"MDE0OlVubGFiZWxlZEV2ZW50MjQwMDk4MjIzNA=="},"added":[],"removed":["bug"]},{"type":5,"author":{"id":"42b8049125821cad60d350df07d9d216b854f3f7"},"timestamp":1560173797,"metadata":{"github-id":"MDEyOkxhYmVsZWRFdmVudDI0MDA5ODIyMzU="},"added":["invalid"],"removed":[]},{"type":3,"author":{"id":"42b8049125821cad60d350df07d9d216b854f3f7"},"timestamp":1597306497,"metadata":{"github-id":"MDEyOklzc3VlQ29tbWVudDY3MzMzMzQ0Mw==","github-url":"https://github.com/rurban/Cpanel-JSON-XS/issues/128#issuecomment-673333443"},"message":"Ok, as workaround I have this so far:\n\n```\nuse Cpanel::JSON::XS;\nmy $json = Cpanel::JSON::XS-\u003enew;\n\n# GH #128 Deep recursion in stringifiy overload\npackage StringifiyRec;\nuse overload '\"\"' =\u003e sub { $json-\u003econvert_blessed(0)-\u003eencode($_[0]) };\npackage main;\nmy $data = bless [], 'StringifiyRec';\nprint $json-\u003econvert_blessed-\u003eallow_blessed-\u003eencode($data);\n```\n\ni.e. add convert_blessed(0) inside your overload sub.","files":null}]}